<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>First Love Church: Women’s Group Bulletin Board</title>

  <style>
    /* (kept your visual styles) */
    :root {
      --bg-color: #f5f2ed;
      --card-bg: #e9e2d0;
      --text-color: #2b2b2b;
      --primary-color: #caa72d;
      --secondary-color: #b83b3b;
      --footer-color: #045f5f;
      --button-bg: #b83b3b;
      --button-hover: #922a2a;
      --shadow: rgba(0,0,0,0.1);
      --prayer-color: #fbc02d;
      --provision-color: #d9c9b6;
      --event-color: #e0a399;
      --update-color: #045f5f;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:"Segoe UI",Arial,sans-serif; background:var(--bg-color); color:var(--text-color); line-height:1.6; font-size:1rem; transition: background 0.3s,color 0.3s; }

    header { display:flex; align-items:center; justify-content:space-between; padding:1rem 2rem; background:var(--bg-color); border-bottom:2px solid var(--primary-color); position:sticky; top:0; z-index:1000; }
    header .logo img { max-height:60px; }
    header h1 { font-size:1.6rem; color:var(--secondary-color); margin-left:1rem; }

    nav { background:var(--primary-color); display:flex; justify-content:center; padding:0.5rem 0; position:sticky; top:70px; z-index:999; }
    .nav-links { display:flex; gap:2rem; list-style:none; }
    .nav-links a { color:white; text-decoration:none; font-weight:600; }
    .nav-links a:hover, .nav-links a:focus { text-decoration:underline; }

    .hamburger { display:none; flex-direction:column; cursor:pointer; position:absolute; right:1rem; }
    .hamburger span { height:3px; width:25px; background:white; margin:4px 0; border-radius:2px; }
    @media (max-width:768px) { 
      .nav-links { display:none; flex-direction:column; background:var(--primary-color); position:absolute; top:100%; right:0; width:200px; padding:1rem; }
      .nav-links.show { display:flex; }
      .hamburger { display:flex; }
    }

    .controls { text-align:center; margin:1rem; display:flex; justify-content:center; gap:0.5rem; flex-wrap:wrap; }
    .controls button { background:var(--button-bg); color:var(--bg-color); border:none; border-radius:6px; padding:0.6rem 1rem; font-size:1rem; cursor:pointer; transition: background 0.3s; }
    .controls button:hover { background:var(--button-hover); }

    .button { display:block; background:var(--button-bg); color:var(--bg-color); padding:1rem; margin:1.5rem auto; border-radius:6px; font-size:1.2rem; text-align:center; border:none; cursor:pointer; max-width:300px; box-shadow:0 3px 6px var(--shadow); transition:background 0.3s; }
    .button:hover, .button:focus { background:var(--button-hover); }

    .section { margin:2rem auto; width:90%; max-width:900px; }
    .section h2 { color:var(--secondary-color); border-bottom:2px solid var(--secondary-color); padding-bottom:0.3rem; margin-bottom:1rem; font-size:1.4rem; }
    .card-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:1.2rem; min-height: 40px; }
    .card { background:var(--card-bg); border-radius:12px; padding:1rem; box-shadow:0 3px 6px var(--shadow); transition: transform 0.2s; border-left:6px solid transparent; }
    .card:hover { transform:translateY(-3px); }
    .card h3 { font-size:1.15rem; margin-bottom:0.5rem; }
    .card p { font-size:1rem; line-height:1.6; }
    .card small { display:block; margin-top:0.5rem; color:#555; font-style:italic; }
    .card.prayer { border-left-color:var(--prayer-color); }
    .card.provision { border-left-color:var(--provision-color); }
    .card.event { border-left-color:var(--event-color); }
    .card.update { border-left-color:var(--update-color); }

    body.dark { background:#2b2b2b; color:#e9e2d0; }
    body.dark .card { background:#3a2f2f; }
    body.dark .card small { color:#ccc; }
    body.large-text { font-size:1.25rem; }

    footer { background:var(--footer-color); color:var(--primary-color); text-align:center; padding:1rem; margin-top:2rem; }
  </style>

  <!-- Tally: put widget script in head per Tally instructions -->
  <script async src="https://tally.so/widgets/embed.js"></script>
  <!-- Supabase client (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <div class="logo">
      <img src="https://raw.githubusercontent.com/Aram814/First_Love_Church/refs/heads/main/first-love-logo-2017.png" alt="First Love Church Logo">
    </div>
    <h1>Women’s Group Bulletin Board</h1>
  </header>

  <nav>
    <div class="hamburger" aria-label="Menu" aria-expanded="false" role="button" tabindex="0">
      <span></span><span></span><span></span>
    </div>
    <ul class="nav-links">
      <li><a href="#prayer">Prayer Request</a></li>
      <li><a href="#provision">Provision Needed</a></li>
      <li><a href="#event">Event</a></li>
      <li><a href="#update">Other Update</a></li>
      <li><a href="members.html">Group Members</a></li>
    </ul>
  </nav>

  <div class="controls">
    <button id="toggle-dark">Toggle Dark Mode</button>
    <button id="toggle-text">Toggle Larger Text</button>
  </div>

  <!-- Add a Post Button (Tally popup via data attributes - official method) -->
  <button class="button"
          data-tally-open="w7AQdP"
          data-tally-layout="modal"
          data-tally-hide-title="1">
    Add a Post
  </button>

  <!-- sections -->
  <div class="section" id="prayer">
    <h2>Prayer Request</h2>
    <div class="card-container" aria-live="polite"></div>
  </div>

  <div class="section" id="provision">
    <h2>Provision Needed</h2>
    <div class="card-container" aria-live="polite"></div>
  </div>

  <div class="section" id="event">
    <h2>Event</h2>
    <div class="card-container" aria-live="polite"></div>
  </div>

  <div class="section" id="update">
    <h2>Other Update</h2>
    <div class="card-container" aria-live="polite"></div>
  </div>

  <footer>&copy; First Love Church – Women’s Group</footer>

  <script>
  // small UI helpers
  const hamburger = document.querySelector(".hamburger");
  const navLinks = document.querySelector(".nav-links");
  hamburger.addEventListener("click", () => {
    const expanded = hamburger.getAttribute("aria-expanded") === "true" || false;
    hamburger.setAttribute("aria-expanded", !expanded);
    navLinks.classList.toggle("show");
  });

  if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark');
  if (localStorage.getItem('largeText') === 'true') document.body.classList.add('large-text');
  document.getElementById('toggle-dark').addEventListener('click', ()=>{
    document.body.classList.toggle('dark');
    localStorage.setItem('darkMode', document.body.classList.contains('dark'));
  });
  document.getElementById('toggle-text').addEventListener('click', ()=>{
    document.body.classList.toggle('large-text');
    localStorage.setItem('largeText', document.body.classList.contains('large-text'));
  });

  // --- Supabase + rendering logic ---
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      // use the exact credentials you provided
      const SUPABASE_URL = "https://btercxzikklbkjpltoey.supabase.co";
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ0ZXJjeHppa2tsYmtqcGx0b2V5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMDU5NjksImV4cCI6MjA3MTU4MTk2OX0.o0iUcb89y0TaN2-ze0cEFxljCt-tsZmbrZDl8NnEGfc";

      // IMPORTANT: do not shadow global 'supabase' — create a distinct client variable
      const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      // tolerant category mapping (case-insensitive)
      const categoryMap = {
        "prayer": "prayer",
        "provision": "provision",
        "event": "event",
        "other update": "update",
        "other": "update"
      };

      // helper: get first non-empty field from a set of candidate keys
      function getField(obj, keys) {
        for (const k of keys) {
          if (obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== "") return obj[k];
        }
        return null;
      }

      function formatDate(d) {
        if (!d) return "";
        const dt = new Date(d);
        if (isNaN(dt)) return String(d);
        return dt.toLocaleDateString();
      }

      function renderPost(post) {
        // locate section id from category (be forgiving)
        const rawCategory = String(post['Category'] || post.Category || "").trim();
        const key = rawCategory.toLowerCase();
        const sectionId = categoryMap[key] || 'update'; // fallback to update

        const container = document.querySelector(`#${sectionId} .card-container`);
        if (!container) return;

        const card = document.createElement('article');
        card.className = `card ${sectionId}`;

        const title = getField(post, ['Title/Subject','Title','title','title_subject']) || "No subject";
        const details = getField(post, ['Details/Description','Details','details','details_description']) || "";
        const name = getField(post, ['Name (Optional)','Name','name']) || "";
        const contact = getField(post, ['Contact Info (Optional)','Contact Info','contact','contact_info']) || "";
        const eventDateRaw = getField(post, ['Event Date','Event_Date','event_date','event date']);
        const createdRaw = getField(post, ['Created_at','created_at','createdAt','created at']);

        let html = `<h3>${escapeHtml(String(title))}</h3>`;
        if (details) html += `<p>${escapeHtml(String(details))}</p>`;
        if (eventDateRaw) html += `<p><small><strong>Event:</strong> ${escapeHtml(formatDate(eventDateRaw))}</small></p>`;
        if (name) html += `<p><small>– ${escapeHtml(String(name))}</small></p>`;
        if (contact) html += `<p><small>Contact: ${escapeHtml(String(contact))}</small></p>`;
        if (createdRaw) html += `<small>Posted: ${escapeHtml(formatDate(createdRaw))}</small>`;

        card.innerHTML = html;
        // newest on top
        container.prepend(card);
      }

      // escape basic HTML to avoid accidental HTML injection in posts
      function escapeHtml(str) {
        return str.replace(/[&<>"']/g, function(m) {
          return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
        });
      }

      // load posts (no reliance on exact created_at column name — sort client-side)
      async function loadPosts() {
        console.log("Fetching rows from Supabase (Submissions)...");
        const { data, error } = await supabaseClient
          .from('Submissions')
          .select('*');

        if (error) {
          console.error("Error fetching posts from Supabase:", error);
          return;
        }
        console.log("Fetched posts:", data);

        // clear containers
        ['prayer','provision','event','update'].forEach(id => {
          const container = document.querySelector(`#${id} .card-container`);
          if (container) container.innerHTML = "";
        });

        // client-side sort: use any timestamp-like field found
        data.sort((a, b) => {
          const aDate = parsePossibleDate(a);
          const bDate = parsePossibleDate(b);
          return bDate - aDate; // newest first
        });

        data.forEach(row => renderPost(row));
      }

      // attempt to parse created / Created_at / created_at etc.
      function parsePossibleDate(row) {
        const candidates = ['Created_at','created_at','createdAt','created at','Created At'];
        for (const k of candidates) {
          if (row[k]) {
            const d = new Date(row[k]);
            if (!isNaN(d)) return d.getTime();
          }
        }
        // fallback: try event date
        const ev = row['Event Date'] || row['event_date'] || row['Event_Date'];
        if (ev) {
          const d = new Date(ev);
          if (!isNaN(d)) return d.getTime();
        }
        return 0;
      }

      // realtime subscription for INSERTs
      async function setupRealtime() {
        try {
          const channel = supabaseClient
            .channel('public:Submissions')
            .on('postgres_changes', { event:'INSERT', schema:'public', table:'Submissions' }, (payload) => {
              console.log("Realtime new row:", payload.new);
              renderPost(payload.new);
            });
          await channel.subscribe();
          console.log("Subscribed to realtime on Submissions");
        } catch (err) {
          console.warn("Realtime subscription error:", err);
        }
      }

      // initial load + realtime
      await loadPosts();
      await setupRealtime();

    } catch (err) {
      console.error("Initialization error:", err);
    }
  }); // DOMContentLoaded
  </script>
</body>
</html>
