<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Women's Fellowship - Meeting Summaries</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Quill.js for the rich text editor -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.75);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background-color: white;
      padding: 2rem;
      border-radius: 1rem;
      max-width: 90%;
      max-height: 90%;
      overflow-y: auto;
      position: relative;
    }
    .dark .modal-content {
      background-color: #3a2f2f;
    }
    .ql-container {
      background-color: white;
      min-height: 200px;
    }
    .dark .ql-container {
      background-color: #2b2b2b;
      color: #ffffff;
    }
  </style>
</head>
<body class="bg-stone-100 text-stone-900 transition-colors duration-300">

  <!-- Header Section - Similar to the main page -->
  <div id="header" class="bg-stone-100 flex flex-col md:flex-row justify-between items-center p-4 md:p-6 shadow-md transition-colors duration-300">
    <div class="flex items-center space-x-4 mb-4 md:mb-0">
      <a href="https://www.firstlovechurch.org/" target="_blank" rel="noopener noreferrer">
        <img
          src="https://raw.githubusercontent.com/Aram814/First_Love_Church/refs/heads/main/first-love-logo-2017.png"
          alt="First Love Church Logo"
          class="h-16 w-16 rounded-full transition-transform duration-200 hover:scale-105"
        />
      </a>
      <h1 id="main-heading" class="text-2xl md:text-3xl font-bold transition-colors duration-300">
        First Love Church
      </h1>
    </div>
    <div class="flex space-x-2">
      <!-- Back button moved to the header -->
      <a href="https://aram814.github.io/First_Love_Church/index.html" class="p-2 rounded-lg text-sm font-semibold transition-transform duration-200 hover:scale-105" style="background-color: #caa72d; color: #2b2b2b;">
        &larr; Back to Bulletin Board
      </a>
      <button
        id="toggle-admin-panel-btn"
        class="p-2 rounded-lg text-sm font-semibold transition-transform duration-200 hover:scale-105 bg-[#b83b3b] text-white"
      >
        Admin
      </button>
      <button
        id="increase-font"
        class="p-2 rounded-lg text-sm font-semibold transition-transform duration-200 hover:scale-105 bg-[#b83b3b] text-white"
      >
        A+
      </button>
      <button
        id="decrease-font"
        class="p-2 rounded-lg text-sm font-semibold transition-transform duration-200 hover:scale-105 bg-[#b83b3b] text-white"
      >
        A-
      </button>
      <button
        id="toggle-theme"
        class="p-2 rounded-lg text-sm font-semibold transition-transform duration-200 hover:scale-105 bg-[#b83b3b] text-white"
      >
        Dark Mode
      </button>
    </div>
  </div>

  <main class="p-4 md:p-6 max-w-4xl mx-auto">
    <div id="status-message" class="text-center p-2 rounded-lg my-4 text-white font-semibold hidden"></div>
    <div id="loading-indicator" class="text-center text-lg">Loading...</div>

    <h2 id="summary-heading" class="text-xl md:text-2xl font-bold transition-colors duration-300">
      Meeting Summaries
    </h2>
    <p class="text-lg text-center mb-8">Click on any card below to view the full meeting summary.</p>

    <div id="summaries-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
      <!-- Dynamic summary cards will be inserted here -->
    </div>
    
    <!-- Admin Login Panel (initially hidden) -->
    <div id="admin-login-panel" class="mt-12 p-6 rounded-xl shadow-lg bg-white dark:bg-gray-800 transition-colors duration-300 hidden">
        <h3 class="text-xl font-semibold mb-4 text-[#b83b3b] dark:text-[#b83b3b]">Admin Login</h3>
        <form id="login-form" class="space-y-4">
            <div>
                <label for="email" class="block text-sm font-medium">Email</label>
                <input type="email" id="email" required class="w-full p-2 rounded-lg border-2 border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#b83b3b]">
            </div>
            <div>
                <label for="password" class="block text-sm font-medium">Password</label>
                <input type="password" id="password" required class="w-full p-2 rounded-lg border-2 border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#b83b3b]">
            </div>
            <button type="submit" class="w-full p-2 rounded-lg font-semibold bg-[#caa72d] text-white hover:bg-yellow-700 transition-transform duration-200 hover:scale-105">
                Log In
            </button>
        </form>
    </div>

    <!-- Admin Submission Panel (initially hidden) -->
    <div id="admin-submission-panel" class="mt-12 p-6 rounded-xl shadow-lg bg-white dark:bg-gray-800 transition-colors duration-300 hidden">
        <h3 id="admin-panel-title" class="text-xl font-semibold mb-4 text-[#b83b3b] dark:text-[#b83b3b]">Admin Panel - Add New Summary</h3>
        <form id="summary-form" class="space-y-4">
            <div>
                <label for="title" class="block text-sm font-medium">Title</label>
                <input type="text" id="title" required class="w-full p-2 rounded-lg border-2 border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#b83b3b]">
            </div>
            <div>
                <label for="date" class="block text-sm font-medium">Date (e.g., August 23, 2024)</label>
                <input type="text" id="date" required class="w-full p-2 rounded-lg border-2 border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#b83b3b]">
            </div>
            <div>
                <label class="block text-sm font-medium">Summary</label>
                <!-- Quill.js editor container -->
                <div id="editor-container"></div>
            </div>
            <button id="submit-btn" type="submit" class="w-full p-2 rounded-lg font-semibold bg-[#caa72d] text-white hover:bg-yellow-700 transition-transform duration-200 hover:scale-105">
                Add Meeting Summary
            </button>
            <button id="cancel-edit-btn" type="button" class="w-full p-2 rounded-lg font-semibold bg-gray-500 text-white hover:bg-gray-700 transition-transform duration-200 hover:scale-105 hidden">
                Cancel
            </button>
        </form>
    </div>
  </main>
  
  <!-- Pop-up Modal for full summary -->
  <div id="summary-modal" class="modal-overlay hidden">
    <div class="modal-content text-stone-900 dark:text-white">
      <button id="close-modal-btn" class="absolute top-4 right-4 text-2xl font-bold text-gray-500 hover:text-gray-900 dark:hover:text-white">&times;</button>
      <h3 id="modal-title" class="text-2xl font-bold mb-2 text-[#b83b3b] dark:text-[#caa72d]"></h3>
      <p id="modal-date" class="text-sm italic mb-4 text-gray-600 dark:text-gray-400"></p>
      <div id="modal-summary" class="text-base"></div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <p class="text-lg font-semibold mb-4 text-center">Are you sure you want to delete this summary?</p>
      <div class="flex justify-around space-x-4">
        <button id="confirm-delete-btn" class="p-2 rounded-lg font-semibold bg-red-500 text-white hover:bg-red-700">Delete</button>
        <button id="cancel-delete-btn" class="p-2 rounded-lg font-semibold bg-gray-500 text-white hover:bg-gray-700">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Quill.js script -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // Global variables provided by the environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // Initialize Supabase client with provided credentials
    const supabase = createClient('https://btercxzikklbkjpltoey.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ0ZXJjeHppa2tsYmtqcGx0b2V5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMDU5NjksImV4cCI6MjA3MTU4MTk2OX0.o0iUcb89y0TaN2-ze0cEFxljCt-tsZmbrZDl8NnEGfc');

    // IMPORTANT: REPLACE THIS WITH YOUR ADMIN USER'S UUID.
    // You can find this in your Supabase project under "Authentication" -> "Users".
    // It's the long string of letters and numbers in the 'ID' column.
    const ADMIN_USER_UUID = 'a4ccd2d4-4497-4735-9ef5-9cabbfa2c0a5'; 

    // DOM elements
    const html = document.documentElement;
    const body = document.body;
    const header = document.getElementById('header');
    const mainHeading = document.getElementById('main-heading');
    const summaryHeading = document.getElementById('summary-heading');
    const toggleThemeBtn = document.getElementById('toggle-theme');
    const increaseFontBtn = document.getElementById('increase-font');
    const decreaseFontBtn = document.getElementById('decrease-font');
    const summariesContainer = document.getElementById('summaries-container');
    const statusMessage = document.getElementById('status-message');
    const loadingIndicator = document.getElementById('loading-indicator');
    const toggleAdminPanelBtn = document.getElementById('toggle-admin-panel-btn');
    const adminLoginPanel = document.getElementById('admin-login-panel');
    const adminSubmissionPanel = document.getElementById('admin-submission-panel');
    const loginForm = document.getElementById('login-form');
    const summaryForm = document.getElementById('summary-form');
    const summaryModal = document.getElementById('summary-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const modalTitle = document.getElementById('modal-title');
    const modalDate = document.getElementById('modal-date');
    const modalSummary = document.getElementById('modal-summary');
    const adminPanelTitle = document.getElementById('admin-panel-title');
    const submitBtn = document.getElementById('submit-btn');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    const deleteModal = document.getElementById('delete-modal');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

    let allSummaries = []; // To store fetched summaries for modal display
    let isUserAdmin = false;
    let currentEditingId = null;

    // Initialize Quill editor
    const quill = new Quill('#editor-container', {
      theme: 'snow',
      placeholder: 'Enter the meeting summary here...',
      modules: {
        toolbar: [
          ['bold', 'italic', 'underline'],
          ['blockquote', 'code-block'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        ]
      }
    });

    // Theme colors
    const colors = {
        light: {
            bg: '#f5f2ed',
            text: '#2b2b2b',
            cardBg: '#e9e2d0',
            primary: '#caa72d',
            secondary: '#b83b3b',
            btnBg: '#b83b3b',
            btnText: '#ffffff'
        },
        dark: {
            bg: '#1E1E1E',
            text: '#ffffff',
            cardBg: '#3a2f2f',
            primary: '#caa72d',
            secondary: '#b83b3b',
            btnBg: '#caa72d',
            btnText: '#ffffff'
        }
    };

    // Function to apply theme
    const applyTheme = (isDark) => {
        const theme = isDark ? colors.dark : colors.light;
        body.style.backgroundColor = theme.bg;
        body.style.color = theme.text;
        header.style.backgroundColor = theme.bg;
        mainHeading.style.color = theme.text;
        summaryHeading.style.color = theme.text;
        toggleThemeBtn.style.backgroundColor = isDark ? colors.dark.btnBg : colors.light.btnBg;
        toggleThemeBtn.style.color = isDark ? colors.dark.btnText : colors.light.btnText;
        increaseFontBtn.style.backgroundColor = isDark ? colors.dark.btnBg : colors.light.btnBg;
        increaseFontBtn.style.color = isDark ? colors.dark.btnText : colors.light.btnText;
        decreaseFontBtn.style.backgroundColor = isDark ? colors.dark.btnBg : colors.light.btnBg;
        decreaseFontBtn.style.color = isDark ? colors.dark.btnText : colors.light.btnText;
        toggleThemeBtn.textContent = isDark ? 'Light Mode' : 'Dark Mode';
        localStorage.setItem('isDarkMode', isDark);

        document.querySelectorAll('.summary-card').forEach(card => {
            card.style.backgroundColor = theme.cardBg;
            card.querySelector('h3').style.color = theme.secondary;
        });
        adminLoginPanel.style.backgroundColor = isDark ? colors.dark.cardBg : colors.light.cardBg;
        adminSubmissionPanel.style.backgroundColor = isDark ? colors.dark.cardBg : colors.light.cardBg;
        
        // Update Quill editor theme
        const quillToolbar = document.querySelector('.ql-toolbar');
        if (quillToolbar) {
            quillToolbar.style.backgroundColor = isDark ? '#2b2b2b' : '#f0f0f0';
        }
    };

    // Function to apply font size
    const applyFontSize = (sizeMultiplier) => {
        document.querySelectorAll('main p, main li, main a, main em, main strong, h2, h3, h4, .ql-editor').forEach(el => {
            el.style.fontSize = `${1 * sizeMultiplier}rem`;
        });
    };

    // Display a temporary status message
    const showStatus = (message, isError = false) => {
        statusMessage.textContent = message;
        statusMessage.classList.remove('hidden');
        if (isError) {
            statusMessage.classList.remove('bg-green-500');
            statusMessage.classList.add('bg-red-500');
        } else {
            statusMessage.classList.remove('bg-red-500');
            statusMessage.classList.add('bg-green-500');
        }
        setTimeout(() => {
            statusMessage.classList.add('hidden');
        }, 5000);
    };

    // Function to fetch and render summaries from Supabase
    const fetchAndRenderSummaries = async () => {
        loadingIndicator.classList.remove('hidden');
        try {
            const { data, error } = await supabase
                .from('meeting_summaries')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error("Error fetching summaries:", error.message);
                showStatus("Error fetching data. Please try again later.", true);
                return;
            }
            
            allSummaries = data;
            renderSummaries(allSummaries);

        } catch (error) {
            console.error("Unexpected error:", error.message);
            showStatus("An unexpected error occurred. Please check the console.", true);
        } finally {
            loadingIndicator.classList.add('hidden');
        }
    };

    // Function to render summary cards
    const renderSummaries = (summaries) => {
        summariesContainer.innerHTML = '';
        if (summaries.length === 0) {
            summariesContainer.innerHTML = '<p class="text-center text-gray-500 mt-8 col-span-full">No meeting summaries found.</p>';
            return;
        }

        summaries.forEach(summary => {
            const isDark = localStorage.getItem('isDarkMode') === 'true';
            const theme = isDark ? colors.dark : colors.light;

            const card = document.createElement('div');
            card.id = `summary-card-${summary.id}`;
            card.className = `p-6 rounded-xl shadow-md transition-all duration-300 summary-card cursor-pointer hover:scale-[1.03] active:scale-[0.98] flex flex-col justify-between`;
            card.style.backgroundColor = theme.cardBg;
            card.dataset.summaryId = summary.id;

            let adminButtons = '';
            if (isUserAdmin) {
                adminButtons = `
                    <div class="flex space-x-2 mt-4">
                        <button class="edit-btn p-2 rounded-lg text-xs font-semibold bg-gray-500 text-white hover:bg-gray-700 transition-transform duration-200 hover:scale-105">
                            Edit
                        </button>
                        <button class="delete-btn p-2 rounded-lg text-xs font-semibold bg-red-500 text-white hover:bg-red-700 transition-transform duration-200 hover:scale-105">
                            Delete
                        </button>
                    </div>
                `;
            }

            card.innerHTML = `
                <div>
                    <h3 class="text-lg font-semibold mb-1" style="color: ${theme.secondary}">${summary.title}</h3>
                    <p class="text-sm italic text-gray-600 dark:text-gray-400">Meeting held on ${summary.date}</p>
                </div>
                ${adminButtons}
            `;
            summariesContainer.appendChild(card);
        });
    };

    // Function to show the modal with summary details
    const showModal = (summary) => {
      modalTitle.textContent = summary.title;
      modalDate.textContent = `Meeting held on ${summary.date}`;
      modalSummary.innerHTML = summary.summary;
      summaryModal.classList.remove('hidden');
    };

    // Function to hide the modal
    const hideModal = () => {
      summaryModal.classList.add('hidden');
    };
    
    // Function to reset the admin form
    const resetForm = () => {
      summaryForm.reset();
      quill.root.innerHTML = '';
      currentEditingId = null;
      adminPanelTitle.textContent = 'Admin Panel - Add New Summary';
      submitBtn.textContent = 'Add Meeting Summary';
      cancelEditBtn.classList.add('hidden');
    };

    // Handle clicks on summary cards, edit, and delete buttons using event delegation
    summariesContainer.addEventListener('click', (e) => {
      const card = e.target.closest('.summary-card');
      if (!card) return;

      const summaryId = card.dataset.summaryId;
      const selectedSummary = allSummaries.find(s => s.id === summaryId);

      if (e.target.classList.contains('delete-btn')) {
        // Handle delete button click
        showDeleteModal(summaryId);
      } else if (e.target.classList.contains('edit-btn')) {
        // Handle edit button click
        if (selectedSummary) {
          document.getElementById('title').value = selectedSummary.title;
          document.getElementById('date').value = selectedSummary.date;
          quill.root.innerHTML = selectedSummary.summary;
          
          currentEditingId = selectedSummary.id;
          adminPanelTitle.textContent = 'Admin Panel - Edit Summary';
          submitBtn.textContent = 'Update Meeting Summary';
          cancelEditBtn.classList.remove('hidden');

          // Ensure admin panel is visible
          adminSubmissionPanel.classList.remove('hidden');
        }
      } else {
        // Handle general card click for modal
        if (selectedSummary) {
          showModal(selectedSummary);
        }
      }
    });

    // Handle closing the modal
    closeModalBtn.addEventListener('click', hideModal);
    summaryModal.addEventListener('click', (e) => {
      if (e.target.id === 'summary-modal') {
        hideModal();
      }
    });

    // Handle delete confirmation modal
    let deleteId = null;
    const showDeleteModal = (id) => {
      deleteId = id;
      deleteModal.classList.remove('hidden');
    };
    const hideDeleteModal = () => {
      deleteId = null;
      deleteModal.classList.add('hidden');
    };
    confirmDeleteBtn.addEventListener('click', async () => {
      await deleteSummary(deleteId);
      hideDeleteModal();
    });
    cancelDeleteBtn.addEventListener('click', hideDeleteModal);

    // Function to delete a summary
    const deleteSummary = async (id) => {
      console.log(`Attempting to delete summary with ID: ${id}`);
      const { error } = await supabase
        .from('meeting_summaries')
        .delete()
        .eq('id', id);
      
      if (error) {
        console.error("Error deleting summary:", error.message);
        showStatus(`Failed to delete summary: ${error.message}`, true);
      } else {
        console.log(`Successfully deleted summary with ID: ${id}`);
        showStatus("Summary deleted successfully!", false);
        fetchAndRenderSummaries();
      }
    };

    // Handle admin button click
    toggleAdminPanelBtn.addEventListener('click', async () => {
        const { data: { user } } = await supabase.auth.getUser();

        // Check if user is already logged in and is the admin
        if (user && user.id === ADMIN_USER_UUID) {
            isUserAdmin = true;
            adminSubmissionPanel.classList.toggle('hidden');
            adminLoginPanel.classList.add('hidden');
            resetForm();
        } else {
            isUserAdmin = false;
            adminLoginPanel.classList.toggle('hidden');
            adminSubmissionPanel.classList.add('hidden');
        }
    });

    // Handle login form submission
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        try {
            const { data, error } = await supabase.auth.signInWithPassword({
                email,
                password,
            });

            if (error) {
                console.error("Login failed:", error.message);
                showStatus("Login failed. Please check your credentials.", true);
            } else if (data.user.id === ADMIN_USER_UUID) {
                isUserAdmin = true;
                showStatus("Login successful! Admin access granted.", false);
                adminLoginPanel.classList.add('hidden');
                adminSubmissionPanel.classList.remove('hidden');
                loginForm.reset();
                fetchAndRenderSummaries(); // Re-render with admin buttons
            } else {
                isUserAdmin = false;
                showStatus("You do not have admin access.", true);
            }
        } catch (error) {
            console.error("An unexpected login error occurred:", error.message);
            showStatus("An unexpected error occurred during login.", true);
        }
    });

    // Handle summary form submission
    summaryForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const title = document.getElementById('title').value;
        const date = document.getElementById('date').value;
        const summary = quill.root.innerHTML; // Get HTML content from Quill

        if (!isUserAdmin) {
            showStatus("You are not authorized to perform this action.", true);
            return;
        }
        
        if (currentEditingId) {
            // Update an existing summary
            const { error } = await supabase
                .from('meeting_summaries')
                .update({ title, date, summary })
                .eq('id', currentEditingId);

            if (error) {
                console.error("Error updating document: ", error.message);
                showStatus("Failed to update summary. Please try again.", true);
            } else {
                showStatus("Meeting summary updated successfully!", false);
                resetForm();
                fetchAndRenderSummaries();
            }
        } else {
            // Add a new summary
            const { error } = await supabase
                .from('meeting_summaries')
                .insert([
                    { title, date, summary }
                ]);

            if (error) {
                console.error("Error adding document: ", error.message);
                showStatus("Failed to add summary. Please try again.", true);
            } else {
                showStatus("Meeting summary added successfully!", false);
                resetForm();
                fetchAndRenderSummaries();
            }
        }
    });
    
    // Handle cancel edit button click
    cancelEditBtn.addEventListener('click', (e) => {
      e.preventDefault();
      resetForm();
    });

    // Event listeners for theme and font size toggles
    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('isDarkMode');
        const isDarkMode = savedTheme === 'true';
        applyTheme(isDarkMode);

        let fontSizeMultiplier = parseFloat(localStorage.getItem('fontSizeMultiplier')) || 1.0;
        applyFontSize(fontSizeMultiplier);

        toggleThemeBtn.addEventListener('click', () => {
            let currentThemeIsDark = localStorage.getItem('isDarkMode') === 'true';
            currentThemeIsDark = !currentThemeIsDark;
            applyTheme(currentThemeIsDark);
        });

        increaseFontBtn.addEventListener('click', () => {
            fontSizeMultiplier = Math.min(fontSizeMultiplier + 0.1, 1.5);
            localStorage.setItem('fontSizeMultiplier', fontSizeMultiplier);
            applyFontSize(fontSizeMultiplier);
        });

        decreaseFontBtn.addEventListener('click', () => {
            fontSizeMultiplier = Math.max(fontSizeMultiplier - 0.1, 0.7);
            localStorage.setItem('fontSizeMultiplier', fontSizeMultiplier);
            applyFontSize(fontSizeMultiplier);
        });

        // Initial fetch of data from Supabase
        fetchAndRenderSummaries();
    });
  </script>
</body>
</html>
